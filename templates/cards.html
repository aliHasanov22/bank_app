{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1"><i class="fas fa-credit-card text-primary"></i> My Cards</h2>
    <small class="text-muted">Manage your cards, limits, and security.</small>
  </div>
  <a href="{{ url_for('order_card') }}" class="btn btn-dark rounded-pill px-4">
    <i class="fas fa-plus"></i> New Card
  </a>
</div>

{% if not cards or cards|length == 0 %}
  <div class="card p-4 text-center">
    <h5 class="mb-2">No cards yet</h5>
    <p class="text-muted mb-3">Order a card to start paying and managing limits.</p>
    <a href="{{ url_for('order_card') }}" class="btn btn-primary rounded-pill px-4">
      <i class="fas fa-plus"></i> Order your first card
    </a>
  </div>
{% else %}

<div class="row">
  {% for c in cards %}
    {% set status = c['status'] %}
    {% set status_class = 'success' if status == 'ACTIVE' else ('warning' if status == 'PENDING' else 'danger') %}
    {% set status_icon  = 'check-circle' if status == 'ACTIVE' else ('clock' if status == 'PENDING' else 'snowflake') %}

    {% set full_num = c['card_number'] %}
    {% set last4 = full_num[-4:] %}
    {% set masked = '**** **** **** ' ~ last4 %}

    <div class="col-md-6 col-lg-4 mb-4">
      <div class="bank-card h-100
          {{ 'bg-gradient-visa' if c['card_type'] == 'VISA' else 'bg-gradient-master' }}
          {{ 'is-frozen' if status == 'BLOCKED' else '' }}
      ">

        <!-- Center watermark logo -->
        <img class="bank-watermark bank-watermark-center"
             src="{{ url_for('static', filename='img/bank-logo.svg') }}"
             alt="Bank logo">

        <!-- Frozen overlay -->
        {% if status == 'BLOCKED' %}
        <div class="frozen-overlay">
          <div class="frozen-badge">
            <i class="fas fa-snowflake me-2"></i>
            <span>Frozen</span>
          </div>
          <small class="opacity-75 mt-2">Payments are blocked</small>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-start position-relative" style="z-index:2;">
          <div>
            <h5 class="mb-1">{{ c['card_name'] }}</h5>
            <span class="badge bg-{{ status_class }} rounded-pill">
              <i class="fas fa-{{ status_icon }} me-1"></i> {{ status }}
            </span>

            {% if status == 'PENDING' %}
              <div class="mt-2"><small class="opacity-75">Waiting for approval</small></div>
            {% elif status == 'BLOCKED' %}
              <div class="mt-2"><small class="opacity-75">Unfreeze in settings</small></div>
            {% endif %}
          </div>

          <i class="fab fa-cc-{{ 'visa' if c['card_type'] == 'VISA' else 'mastercard' }} fa-2x"></i>
        </div>

        <!-- Card number + eye toggle -->
        <div class="mt-4 position-relative" style="z-index:2;">
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="card-chip"></div>

            <button type="button"
                    class="btn btn-sm btn-light rounded-pill px-3 opacity-90 card-eye-btn"
                    data-target="cardnum-{{ loop.index }}"
                    data-masked="{{ masked }}"
                    data-full="{{ full_num }}"
                    aria-label="Show card number">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <div id="cardnum-{{ loop.index }}" class="card-number fs-6 mt-2">
            {{ masked }}
          </div>
        </div>

        <div class="mt-3 position-relative" style="z-index:2;">
          <small class="opacity-75">Available Balance</small>
          <div class="card-balance">{{ "%.2f"|format(c['balance']) }} {{ c['currency'] }}</div>
        </div>

        <div class="d-grid mt-3 position-relative" style="z-index:2;">
          <a href="{{ url_for('card_settings', card_num=c['card_number']) }}"
             class="btn btn-light text-dark btn-sm rounded-pill opacity-90">
            <i class="fas fa-cog"></i> Settings
          </a>
        </div>

      </div>
    </div>
  {% endfor %}
</div>

<!-- Tiny JS: toggle masked/full number -->
<script>
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.card-eye-btn');
    if (!btn) return;

    const id = btn.getAttribute('data-target');
    const el = document.getElementById(id);
    if (!el) return;

    const masked = btn.getAttribute('data-masked');
    const full = btn.getAttribute('data-full');

    const isMasked = (el.textContent.trim() === masked.trim());

    el.textContent = isMasked ? full : masked;

    // swap icon
    const icon = btn.querySelector('i');
    if (icon) icon.className = isMasked ? 'fas fa-eye-slash' : 'fas fa-eye';

    btn.setAttribute('aria-label', isMasked ? 'Hide card number' : 'Show card number');
  });
</script>

{% endif %}
{% endblock %}
